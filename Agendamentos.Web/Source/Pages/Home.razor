@using Agendamentos.Web.Source.Components
@using System.Text.Json
@using System.Threading.Tasks
@rendermode InteractiveServer
@inject NavigationManager NavManager
@page "/"

<PageTitle>Agendamentos</PageTitle>

<div id="container">

	<div id="schedule">

		<div id="title">
			<h1 class="title_lg gray-100">Agende um atendimento</h1>
			<p class="text_sm gray-300">Selecione data, horário e informe o nome do cliente para criar o agendamento</p>
		</div>

		<div id="form">

			<div id="date">
				<h1 class="title_md gray-200">Data</h1>
				<DateInput MinimumToday Value="SelectedDate" ValueChanged="FormDateChanged">
					<IconContent>
						<CalendarMonth />
					</IconContent>
				</DateInput>
			</div>

			<div id="time">
				<h1 class="title_md gray-200">Horários</h1>
				<div id="time_display">
					@foreach (var timeSlot in AvailableTimeSlots)
					{
						<TimeSelect Name="Time"
									Time="@timeSlot"
									IsSelected="@(SelectedTime == timeSlot)"
									TimeSelected="SelectTime" />

					}
				</div>
			</div>

			<div id="service">
				<h1 class="title_md gray-200">Serviço</h1>
				<ServiceSelector @bind-SelectedId="SelectedServiceId" />
			</div>

			<div id="employee">
				<h1 class="title_md gray-200">Funcionário</h1>
				<EmployeSelector @bind-SelectedId="SelectedEmployeeId" />
			</div>

			<div id="client">
				<h1 class="title_md gray-200">Cliente</h1>
				<ClientSelector @bind-SelectedId="SelectedClientId" />
			</div>


		</div>

		<Button Text="Agendar" OnClick="CreateAppointmentAsync"></Button>
	</div>

	<div id="agenda">
		<div id="layout_header">
			<div id="agenda_header">
				<h1 class="title_lg">Sua agenda</h1>
				<p class="text_sm">Consulte os seus agendamentos de serviço por dia</p>
			</div>

			<DateInput Value="FilterDate" ValueChanged="FilterDateChanged">
				<IconContent>
					<CalendarMonth />
				</IconContent>
			</DateInput>
		</div>

		<div id="agendamentos">
			<div id="agendamentos_header">
				<span style="color:var(--yellow-dark);"><CalendarToday /></span>
				<p class="text_sm">Agendamentos</p>
			</div>

			<div id="lista">
				<span class="title_md gray-100"><AppointmentItem Horario="Horário" Cliente="Cliente" Funcionario="Funcionário" /></span>
				@if (Appointments.Count < 1)
				{
					<span class="text_md gray-200">Nenhum agendamento encontrado</span>
				}
				else
				{
					foreach (var appointment in Appointments)
					{
						<span class="text_md gray-200">
							<AppointmentItem Horario="@appointment.ScheduledAt.ToString("t")"
											 Cliente="@appointment.ClientName"
											 Funcionario="@appointment.EmployeeName"
											 Service="@appointment.ServiceName"
											 PrecoTotal="@appointment.TotalPrice.ToString("C")" />
						</span>
					}
				}
			</div>

		</div>

	</div>

</div>

@code {
	[Inject]
	private IHttpClientFactory _httpClientFactory { get; set; } = default!;

	public List<ServiceDto>? Services { get; set; }
	public List<AppointmentDto> Appointments { get; set; } = [];

	public Dictionary<int, string> ServicesDictionary { get; set; } = [];

	// Propriedades para o novo Agendamento
	public DateTime SelectedDate { get; set; } = DateTime.Today;
	public string? SelectedTime { get; set; }
	public DateTime FilterDate { get; set; } = DateTime.Today;
	private List<string> AvailableTimeSlots = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00"];


	private void SelectTime(string time)
	{
		SelectedTime = time;
	}

	public int SelectedClientId { get; set; }
	public int SelectedEmployeeId { get; set; }
	public int SelectedServiceId { get; set; }

	private AppointmentRegistrationDto AppointmentModel { get; set; } = new();

	protected override async Task OnInitializedAsync()
	{
		await LoadAppointmentsAsync(FilterDate);
	}

	private async Task LoadAppointmentsAsync(DateTime date)
	{
		try
		{
			var httpClient = _httpClientFactory.CreateClient("API");

			var dateString = date.ToString("yyyy-MM-dd");

			var response = await httpClient.GetAsync($"appointment/get_all?date={dateString}");

			if (response.IsSuccessStatusCode)
			{
				var content = await response.Content.ReadAsStringAsync();
				Appointments = JsonSerializer.Deserialize<List<AppointmentDto>>(content,
					new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? [];

				// if (Appointments != null)
				// {
				//     ServicesDictionary = Services.ToDictionary(e => e.ID, e => e.Name);
				// }
			}
			else
			{
				Console.WriteLine($"Erro ao carregar os dados: {response.StatusCode}");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Houve uma exceção ao carregar funcionários: ${ex.Message}");
		}
	}

	private async Task CreateAppointmentAsync()
	{
		try
		{
			if (TimeSpan.TryParse(SelectedTime, out var timeSpan))
			{
				var scheduleDateTime = SelectedDate.Date.Add(timeSpan);
				AppointmentModel.ScheduledAt = scheduleDateTime;
			}
			AppointmentModel.ClientID = SelectedClientId;
			AppointmentModel.EmployeeID = SelectedEmployeeId;
			AppointmentModel.ServiceID = SelectedServiceId;

			var httpClient = _httpClientFactory.CreateClient("API");
			var response = await httpClient.PostAsJsonAsync("appointment/register", AppointmentModel);

			if (response.IsSuccessStatusCode)
			{
				NavManager.NavigateTo(NavManager.Uri, true);
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Houve uma exceção ao carregar funcionários: ${ex.Message}");
		}
	}

	private async Task FilterDateChanged(DateTime newDate)
	{
		FilterDate = newDate;
		await LoadAppointmentsAsync(newDate);
	}
	private void FormDateChanged(DateTime newDate)
	{
		SelectedDate = newDate;
	}
}